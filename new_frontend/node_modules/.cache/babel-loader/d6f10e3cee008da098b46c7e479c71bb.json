{"ast":null,"code":"import _regeneratorRuntime from\"/home/ondaniel/santiago/sisgie/new_frontend/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/ondaniel/santiago/sisgie/new_frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/ondaniel/santiago/sisgie/new_frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState,useCallback,useRef}from'react';import{useParams}from'react-router-dom';import{Form}from'@unform/web';import{FiDollarSign}from'react-icons/fi';import{ValidationError as YupValidationError}from'yup';import{toast}from'react-toastify';import{isPast,differenceInCalendarMonths,parseISO}from'date-fns';import{Container,Main,InputGroup,Debit}from'./styles';import{paymentMethods}from'../../utils/defaults';import Loading from'../../components/Loading';import Title from'../../components/Title';import Table from'../../components/Table';import Header from'../../components/Header';import Aside from'../../components/Aside';import Select from'../../components/SelectInput';import Button from'../../components/Button';import Popup from'../../components/Popup';import Document from'../../components/Document';import api from'../../services/api';import paymentSchema from'../../schemas/paymentSchema';import getValidationErrors from'../../utils/getValidationErrors';import{prettyDate,formatCoin}from'../../utils/formatFunctions';toast.configure();var Debits=function Debits(){var formRef=useRef(null);var _useParams=useParams(),contract_id=_useParams.contract_id;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),debits=_useState2[0],setDebits=_useState2[1];var _useState3=useState({}),_useState4=_slicedToArray(_useState3,2),selectedDebit=_useState4[0],setSelectedDebit=_useState4[1];var _useState5=useState({}),_useState6=_slicedToArray(_useState5,2),payment=_useState6[0],setPayment=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),loadingPage=_useState8[0],setLoadingPage=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),loadingSubmit=_useState10[0],setLoadingSubmit=_useState10[1];useEffect(function(){setLoadingPage(true);api.get(\"contracts/\".concat(contract_id,\"/debits\")).then(function(response){var debitsFromApi=response.data;debitsFromApi.forEach(function(debit){var parsedDebitDate=parseISO(debit.payment_limit_date.toString());var true_value=Number(debit.value);if(isPast(parsedDebitDate)&&debit.apply_interest_rules){var months=differenceInCalendarMonths(new Date(),parsedDebitDate);true_value=debit.value*Math.pow(1.03,months);}else if(!isPast(parsedDebitDate)){true_value=debit.value-debit.value*debit.discount/100;}Object.assign(debit,{true_value:true_value});});setDebits(response.data);}).catch(function(){toast.error('Erro ao carregar débitos! Por favor, tente novamente mais tarde.');}).finally(function(){setLoadingPage(false);});},[contract_id]);var handlePayDebit=useCallback(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(data){var _formRef$current,apiUrl,response,paymentData,debitsList,newDebits,debitsFromApi,_formRef$current2,errors;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!loadingSubmit){_context.next=2;break;}return _context.abrupt(\"return\");case 2:setLoadingSubmit(true);_context.prev=3;(_formRef$current=formRef.current)===null||_formRef$current===void 0?void 0:_formRef$current.setErrors({});_context.next=7;return paymentSchema.validate(data,{abortEarly:false});case 7:apiUrl=selectedDebit.type==='enrollment'?'/payments/enrollment':'/payments';_context.next=10;return api.post(apiUrl,{debit_id:selectedDebit.id,method:data.method});case 10:response=_context.sent;paymentData=response.data;setPayment(paymentData);debitsList=debits;debitsList.forEach(function(debit){if(debit.id===selectedDebit.id){Object.assign(debit,{paid:true,payment:paymentData});}});setDebits(debitsList);toast.success('Débito pago com sucesso!');if(!(selectedDebit.type==='enrollment')){_context.next=24;break;}_context.next=20;return api.get(\"contracts/\".concat(contract_id,\"/debits\"));case 20:newDebits=_context.sent;debitsFromApi=newDebits.data;debitsFromApi.forEach(function(debit){var parsedDebitDate=parseISO(debit.payment_limit_date.toString());var true_value=debit.value;if(isPast(parsedDebitDate)&&debit.apply_interest_rules){var months=differenceInCalendarMonths(new Date(),parsedDebitDate);true_value=debit.value*Math.pow(1.03,months);}else{true_value=debit.value-debit.value*debit.discount/100;}Object.assign(debit,{true_value:true_value});});setDebits(newDebits.data);case 24:_context.next=33;break;case 26:_context.prev=26;_context.t0=_context[\"catch\"](3);if(!(_context.t0 instanceof YupValidationError)){_context.next=32;break;}errors=getValidationErrors(_context.t0);(_formRef$current2=formRef.current)===null||_formRef$current2===void 0?void 0:_formRef$current2.setErrors(errors);return _context.abrupt(\"return\");case 32:if(_context.t0.response){toast.error(\"Erro ao pagar d\\xE9bito: \".concat(_context.t0.response.data.message));}else{toast.error(\"Erro ao pagar d\\xE9bito! Por favor, tente novamente mais tarde.\");}case 33:_context.prev=33;setLoadingSubmit(false);return _context.finish(33);case 36:case\"end\":return _context.stop();}}},_callee,null,[[3,26,33,36]]);}));return function(_x){return _ref.apply(this,arguments);};}(),[selectedDebit,debits,loadingSubmit,contract_id]);var handleClosePopup=useCallback(function(){setSelectedDebit({});setPayment({});},[]);return/*#__PURE__*/React.createElement(Container,null,/*#__PURE__*/React.createElement(Loading,{show:loadingPage}),/*#__PURE__*/React.createElement(Header,null),/*#__PURE__*/React.createElement(Aside,null),/*#__PURE__*/React.createElement(Main,null,/*#__PURE__*/React.createElement(Title,{title:\"Pagar d\\xE9bitos\",subtitle:\"Contrato #\".concat(contract_id)}),/*#__PURE__*/React.createElement(Table,{isVoid:debits.length<=0,voidMessage:\"N\\xE3o h\\xE1 d\\xE9bitos para serem pagos!\"},/*#__PURE__*/React.createElement(\"thead\",null,/*#__PURE__*/React.createElement(\"tr\",null,/*#__PURE__*/React.createElement(\"td\",null,\"Descri\\xE7\\xE3o\"),/*#__PURE__*/React.createElement(\"td\",null,\"Valor\"),/*#__PURE__*/React.createElement(\"td\",null,\"Valor com varia\\xE7\\xE3o\"),/*#__PURE__*/React.createElement(\"td\",null,\"Data limite do pagamento\"),/*#__PURE__*/React.createElement(\"td\",null,\"Data de pagamento\"))),/*#__PURE__*/React.createElement(\"tbody\",null,debits.map(function(debit){return/*#__PURE__*/React.createElement(Debit,{paid:debit.paid,key:debit.id,onClick:function onClick(){return setSelectedDebit(debit);}},/*#__PURE__*/React.createElement(\"td\",null,debit.description),/*#__PURE__*/React.createElement(\"td\",null,formatCoin(debit.value)),/*#__PURE__*/React.createElement(\"td\",null,debit.true_value?formatCoin(debit.true_value):formatCoin(debit.value)),/*#__PURE__*/React.createElement(\"td\",null,prettyDate(debit.payment_limit_date)),/*#__PURE__*/React.createElement(\"td\",null,debit.payday?prettyDate(debit.payday):'-'));}))),!!selectedDebit.id&&/*#__PURE__*/React.createElement(Popup,{title:\"D\\xE9bito: \".concat(selectedDebit.true_value?formatCoin(selectedDebit.true_value):formatCoin(selectedDebit.value)),handleClosePopup:handleClosePopup},!payment.id&&!selectedDebit.paid&&/*#__PURE__*/React.createElement(Form,{ref:formRef,onSubmit:handlePayDebit},/*#__PURE__*/React.createElement(InputGroup,null,/*#__PURE__*/React.createElement(Select,{name:\"method\",icon:FiDollarSign,optionsArray:paymentMethods})),/*#__PURE__*/React.createElement(Button,{type:\"submit\",loading:loadingSubmit},\"Pagar\")),(payment.receipt_url||selectedDebit.payment&&selectedDebit.payment.receipt_url)&&/*#__PURE__*/React.createElement(Document,{name:\"Recibo\",link:payment.receipt_url||selectedDebit.payment.receipt_url||''}))));};export default Debits;","map":{"version":3,"sources":["/home/ondaniel/santiago/sisgie/new_frontend/src/pages/PayDebitsByContract/index.tsx"],"names":["React","useEffect","useState","useCallback","useRef","useParams","Form","FiDollarSign","ValidationError","YupValidationError","toast","isPast","differenceInCalendarMonths","parseISO","Container","Main","InputGroup","Debit","paymentMethods","Loading","Title","Table","Header","Aside","Select","Button","Popup","Document","api","paymentSchema","getValidationErrors","prettyDate","formatCoin","configure","Debits","formRef","contract_id","debits","setDebits","selectedDebit","setSelectedDebit","payment","setPayment","loadingPage","setLoadingPage","loadingSubmit","setLoadingSubmit","get","then","response","debitsFromApi","data","forEach","debit","parsedDebitDate","payment_limit_date","toString","true_value","Number","value","apply_interest_rules","months","Date","discount","Object","assign","catch","error","finally","handlePayDebit","current","setErrors","validate","abortEarly","apiUrl","type","post","debit_id","id","method","paymentData","debitsList","paid","success","newDebits","errors","message","handleClosePopup","length","map","description","payday","receipt_url"],"mappings":"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","sourcesContent":["import React, { useEffect, useState, useCallback, useRef } from 'react';\nimport { useParams } from 'react-router-dom';\nimport { Form } from '@unform/web';\nimport { FormHandles } from '@unform/core';\nimport { FiDollarSign } from 'react-icons/fi';\nimport { ValidationError as YupValidationError } from 'yup';\nimport { toast } from 'react-toastify';\nimport { isPast, differenceInCalendarMonths, parseISO } from 'date-fns';\n\nimport { Container, Main, InputGroup, Debit } from './styles';\nimport { paymentMethods } from '../../utils/defaults';\nimport Loading from '../../components/Loading';\nimport Title from '../../components/Title';\nimport Table from '../../components/Table';\nimport Header from '../../components/Header';\nimport Aside from '../../components/Aside';\nimport Select from '../../components/SelectInput';\nimport Button from '../../components/Button';\nimport Popup from '../../components/Popup';\nimport Document from '../../components/Document';\nimport IDebit from '../../entities/IDebit';\nimport IPayment from '../../entities/IPayment';\nimport api from '../../services/api';\nimport paymentSchema from '../../schemas/paymentSchema';\nimport getValidationErrors from '../../utils/getValidationErrors';\nimport { prettyDate, formatCoin } from '../../utils/formatFunctions';\n\ninterface IFormData {\n  method: 'creditCard' | 'debitCard' | 'cash' | 'check' | 'deposit' | 'slip';\n}\n\ninterface IParams {\n  contract_id: string;\n}\n\ninterface IDebitWithVariation extends IDebit {\n  true_value?: number;\n}\n\ntoast.configure();\n\nconst Debits: React.FC = () => {\n  const formRef = useRef<FormHandles>(null);\n\n  const { contract_id } = useParams<IParams>();\n\n  const [debits, setDebits] = useState([] as IDebitWithVariation[]);\n  const [selectedDebit, setSelectedDebit] = useState({} as IDebitWithVariation);\n  const [payment, setPayment] = useState({} as IPayment);\n  const [loadingPage, setLoadingPage] = useState(false);\n  const [loadingSubmit, setLoadingSubmit] = useState(false);\n\n  useEffect(() => {\n    setLoadingPage(true);\n    api\n      .get(`contracts/${contract_id}/debits`)\n      .then(response => {\n        const debitsFromApi = response.data;\n\n        debitsFromApi.forEach((debit: IDebitWithVariation) => {\n          const parsedDebitDate = parseISO(debit.payment_limit_date.toString());\n\n          let true_value = Number(debit.value);\n\n          if (isPast(parsedDebitDate) && debit.apply_interest_rules) {\n            const months = differenceInCalendarMonths(\n              new Date(),\n              parsedDebitDate,\n            );\n\n            true_value = debit.value * 1.03 ** months;\n          } else if (!isPast(parsedDebitDate)) {\n            true_value = debit.value - (debit.value * debit.discount) / 100;\n          }\n\n          Object.assign(debit, { true_value });\n        });\n\n        setDebits(response.data);\n      })\n      .catch(() => {\n        toast.error(\n          'Erro ao carregar débitos! Por favor, tente novamente mais tarde.',\n        );\n      })\n      .finally(() => {\n        setLoadingPage(false);\n      });\n  }, [contract_id]);\n\n  const handlePayDebit = useCallback(\n    async (data: IFormData) => {\n      if (loadingSubmit) {\n        return;\n      }\n\n      setLoadingSubmit(true);\n\n      try {\n        formRef.current?.setErrors({});\n\n        await paymentSchema.validate(data, {\n          abortEarly: false,\n        });\n\n        const apiUrl =\n          selectedDebit.type === 'enrollment'\n            ? '/payments/enrollment'\n            : '/payments';\n\n        const response = await api.post(apiUrl, {\n          debit_id: selectedDebit.id,\n          method: data.method,\n        });\n\n        const paymentData = response.data as IPayment;\n\n        setPayment(paymentData);\n\n        const debitsList = debits;\n\n        debitsList.forEach(debit => {\n          if (debit.id === selectedDebit.id) {\n            Object.assign(debit, {\n              paid: true,\n              payment: paymentData,\n            });\n          }\n        });\n\n        setDebits(debitsList);\n\n        toast.success('Débito pago com sucesso!');\n\n        if (selectedDebit.type === 'enrollment') {\n          const newDebits = await api.get(`contracts/${contract_id}/debits`);\n\n          const debitsFromApi = newDebits.data;\n\n          debitsFromApi.forEach((debit: IDebitWithVariation) => {\n            const parsedDebitDate = parseISO(\n              debit.payment_limit_date.toString(),\n            );\n\n            let true_value = debit.value;\n\n            if (isPast(parsedDebitDate) && debit.apply_interest_rules) {\n              const months = differenceInCalendarMonths(\n                new Date(),\n                parsedDebitDate,\n              );\n\n              true_value = debit.value * 1.03 ** months;\n            } else {\n              true_value = debit.value - (debit.value * debit.discount) / 100;\n            }\n\n            Object.assign(debit, { true_value });\n          });\n\n          setDebits(newDebits.data);\n        }\n      } catch (err) {\n        if (err instanceof YupValidationError) {\n          const errors = getValidationErrors(err);\n\n          formRef.current?.setErrors(errors);\n\n          return;\n        }\n\n        if (err.response) {\n          toast.error(`Erro ao pagar débito: ${err.response.data.message}`);\n        } else {\n          toast.error(\n            `Erro ao pagar débito! Por favor, tente novamente mais tarde.`,\n          );\n        }\n      } finally {\n        setLoadingSubmit(false);\n      }\n    },\n    [selectedDebit, debits, loadingSubmit, contract_id],\n  );\n\n  const handleClosePopup = useCallback(() => {\n    setSelectedDebit({} as IDebitWithVariation);\n    setPayment({} as IPayment);\n  }, []);\n\n  return (\n    <Container>\n      <Loading show={loadingPage} />\n\n      <Header />\n\n      <Aside />\n\n      <Main>\n        <Title title=\"Pagar débitos\" subtitle={`Contrato #${contract_id}`} />\n\n        <Table\n          isVoid={debits.length <= 0}\n          voidMessage=\"Não há débitos para serem pagos!\"\n        >\n          <thead>\n            <tr>\n              <td>Descrição</td>\n              <td>Valor</td>\n              <td>Valor com variação</td>\n              <td>Data limite do pagamento</td>\n              <td>Data de pagamento</td>\n            </tr>\n          </thead>\n          <tbody>\n            {debits.map(debit => (\n              <Debit\n                paid={debit.paid}\n                key={debit.id}\n                onClick={() => setSelectedDebit(debit)}\n              >\n                <td>{debit.description}</td>\n                <td>{formatCoin(debit.value)}</td>\n                <td>\n                  {debit.true_value\n                    ? formatCoin(debit.true_value)\n                    : formatCoin(debit.value)}\n                </td>\n                <td>{prettyDate(debit.payment_limit_date)}</td>\n                <td>{debit.payday ? prettyDate(debit.payday) : '-'}</td>\n              </Debit>\n            ))}\n          </tbody>\n        </Table>\n\n        {!!selectedDebit.id && (\n          <Popup\n            title={`Débito: ${\n              selectedDebit.true_value\n                ? formatCoin(selectedDebit.true_value)\n                : formatCoin(selectedDebit.value)\n            }`}\n            handleClosePopup={handleClosePopup}\n          >\n            {!payment.id && !selectedDebit.paid && (\n              <Form ref={formRef} onSubmit={handlePayDebit}>\n                <InputGroup>\n                  <Select\n                    name=\"method\"\n                    icon={FiDollarSign}\n                    optionsArray={paymentMethods}\n                  />\n                </InputGroup>\n\n                <Button type=\"submit\" loading={loadingSubmit}>\n                  Pagar\n                </Button>\n              </Form>\n            )}\n\n            {(payment.receipt_url ||\n              (selectedDebit.payment && selectedDebit.payment.receipt_url)) && (\n              <Document\n                name=\"Recibo\"\n                link={\n                  payment.receipt_url || selectedDebit.payment.receipt_url || ''\n                }\n              />\n            )}\n          </Popup>\n        )}\n      </Main>\n    </Container>\n  );\n};\n\nexport default Debits;\n"]},"metadata":{},"sourceType":"module"}