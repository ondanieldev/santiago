{"ast":null,"code":"import _regeneratorRuntime from\"/home/ondaniel/santiago/sisgie/new_frontend/node_modules/@babel/runtime/regenerator\";import _toConsumableArray from\"/home/ondaniel/santiago/sisgie/new_frontend/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _asyncToGenerator from\"/home/ondaniel/santiago/sisgie/new_frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/ondaniel/santiago/sisgie/new_frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState,useCallback,useRef}from'react';import{useParams}from'react-router-dom';import{Form}from'@unform/web';import{FiCalendar,FiDollarSign,FiFileText,FiPercent,FiEdit2,FiTrash,FiCheck}from'react-icons/fi';import*as Yup from'yup';import{toast}from'react-toastify';import{isPast,differenceInCalendarMonths,parseISO}from'date-fns';import{Container,Main,InputGroup,Debit,FormGroup,ButtonGroup,ActionGroup,WarnMessage}from'./styles';import Loading from'../../components/Loading';import Title from'../../components/Title';import Table from'../../components/Table';import Header from'../../components/Header';import Aside from'../../components/Aside';import Input from'../../components/Input';import Button from'../../components/Button';import Popup from'../../components/Popup';import api from'../../services/api';import getValidationErrors from'../../utils/getValidationErrors';import{prettyDate,formatCoin}from'../../utils/formatFunctions';import Checkbox from'../../components/Checkbox';var ExtraDebitsByContract=function ExtraDebitsByContract(){var formRef=useRef(null);var _useParams=useParams(),contract_id=_useParams.contract_id;var _useState=useState([]),_useState2=_slicedToArray(_useState,2),debits=_useState2[0],setDebits=_useState2[1];var _useState3=useState(''),_useState4=_slicedToArray(_useState3,2),selectedEditDebit=_useState4[0],setSelectedEditDebit=_useState4[1];var _useState5=useState(''),_useState6=_slicedToArray(_useState5,2),selectedDeleteDebit=_useState6[0],setSelectedDeleteDebit=_useState6[1];var _useState7=useState(false),_useState8=_slicedToArray(_useState7,2),loadingPage=_useState8[0],setLoadingPage=_useState8[1];var _useState9=useState(false),_useState10=_slicedToArray(_useState9,2),loadingSubmit=_useState10[0],setLoadingSubmit=_useState10[1];var _useState11=useState(''),_useState12=_slicedToArray(_useState11,2),confirmMessage=_useState12[0],setConfirmMessage=_useState12[1];var handleSelectEditExtraDebit=useCallback(function(debit){var _formRef$current,_formRef$current2,_formRef$current3,_formRef$current4,_formRef$current5;setSelectedEditDebit(debit.id);(_formRef$current=formRef.current)===null||_formRef$current===void 0?void 0:_formRef$current.setErrors({});(_formRef$current2=formRef.current)===null||_formRef$current2===void 0?void 0:_formRef$current2.setFieldValue('description',debit.description);(_formRef$current3=formRef.current)===null||_formRef$current3===void 0?void 0:_formRef$current3.setFieldValue('value',debit.value);(_formRef$current4=formRef.current)===null||_formRef$current4===void 0?void 0:_formRef$current4.setFieldValue('discount',debit.discount);(_formRef$current5=formRef.current)===null||_formRef$current5===void 0?void 0:_formRef$current5.setFieldValue('payment_limit_date',debit.payment_limit_date);},[]);var handleUnselectExtraDebit=useCallback(function(){var _formRef$current6,_formRef$current7;setSelectedEditDebit('');setSelectedDeleteDebit('');(_formRef$current6=formRef.current)===null||_formRef$current6===void 0?void 0:_formRef$current6.setErrors({});(_formRef$current7=formRef.current)===null||_formRef$current7===void 0?void 0:_formRef$current7.reset();},[]);var handleSelectDeleteExtraDebit=useCallback(function(deibt_id){setSelectedDeleteDebit(deibt_id);},[]);var calcTrueValue=useCallback(function(debit){var parsedDebitDate=parseISO(debit.payment_limit_date.toString());var true_value=Number(debit.value);if(isPast(parsedDebitDate)&&debit.apply_interest_rules){var months=differenceInCalendarMonths(new Date(),parsedDebitDate);true_value=debit.value*Math.pow(1.03,months);}else if(!isPast(parsedDebitDate)){true_value=debit.value-debit.value*debit.discount/100;}return true_value;},[]);var handleEditExtraDebit=useCallback(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(_ref){var description,discount,payment_limit_date,value,apply_interest_rules,_formRef$current8,_formRef$current9,validateFormData,response,updatedDebit,true_value,debitsWithoutUpdated,_formRef$current10,errors;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:description=_ref.description,discount=_ref.discount,payment_limit_date=_ref.payment_limit_date,value=_ref.value,apply_interest_rules=_ref.apply_interest_rules;_context.prev=1;setLoadingSubmit(true);(_formRef$current8=formRef.current)===null||_formRef$current8===void 0?void 0:_formRef$current8.setErrors({});validateFormData=Yup.object().shape({description:Yup.string().required('Descrião obrigatória'),discount:Yup.number().typeError(function(){return'Desconto precisa ser numérico';}),payment_limit_date:Yup.date().typeError(function(){return'Deata inválida';}).required(),value:Yup.number().typeError(function(){return'O valor precisa ser numérico';}).required()});_context.next=7;return validateFormData.validate({description:description,discount:discount,payment_limit_date:payment_limit_date,value:value},{abortEarly:false});case 7:_context.next=9;return api.put(\"/debits/extra/\".concat(selectedEditDebit),{description:description,discount:discount,payment_limit_date:payment_limit_date,value:value,apply_interest_rules:apply_interest_rules});case 9:response=_context.sent;updatedDebit=response.data;true_value=calcTrueValue(updatedDebit);Object.assign(updatedDebit,{true_value:true_value});debitsWithoutUpdated=debits.filter(function(debit){return debit.id!==selectedEditDebit;});setDebits([].concat(_toConsumableArray(debitsWithoutUpdated),[updatedDebit]));(_formRef$current9=formRef.current)===null||_formRef$current9===void 0?void 0:_formRef$current9.reset();setSelectedEditDebit('');toast.success('Débito editado com sucesso!');_context.next=28;break;case 20:_context.prev=20;_context.t0=_context[\"catch\"](1);if(!(_context.t0 instanceof Yup.ValidationError)){_context.next=27;break;}errors=getValidationErrors(_context.t0);(_formRef$current10=formRef.current)===null||_formRef$current10===void 0?void 0:_formRef$current10.setErrors(errors);toast.error('Oops... alguns dados não foram preenchidos corretamente!');return _context.abrupt(\"return\");case 27:if(_context.t0.response){toast.error(\"Erro ao editar d\\xE9bito: \".concat(_context.t0.response.data.message));}else{toast.error('Erro interno do servidor! Por favor, tente novamente mais tarde.');}case 28:_context.prev=28;setLoadingSubmit(false);return _context.finish(28);case 31:case\"end\":return _context.stop();}}},_callee,null,[[1,20,28,31]]);}));return function(_x){return _ref2.apply(this,arguments);};}(),[selectedEditDebit,calcTrueValue,debits]);var handleClosePopup=useCallback(function(){setSelectedDeleteDebit('');},[]);var handleDeleteExtraDebit=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var debitsWithoutDeleted;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;setLoadingSubmit(true);_context2.next=4;return api.delete(\"/debits/extra/\".concat(selectedDeleteDebit));case 4:setSelectedDeleteDebit('');debitsWithoutDeleted=debits.filter(function(debit){return debit.id!==selectedDeleteDebit;});setDebits(debitsWithoutDeleted);toast.success('Débito excluído com sucesso!');_context2.next=13;break;case 10:_context2.prev=10;_context2.t0=_context2[\"catch\"](0);if(_context2.t0.response){toast.error(\"Erro ao excluir d\\xE9bito: \".concat(_context2.t0.response.data.message));}else{toast.error('Erro interno do servidor! Por favor, tente novamente mais tarde.');}case 13:case\"end\":return _context2.stop();}}},_callee2,null,[[0,10]]);})),[selectedDeleteDebit,debits]);useEffect(function(){setLoadingPage(true);api.get(\"contracts/\".concat(contract_id,\"/debits/extra\")).then(function(response){var debitsFromApi=response.data;debitsFromApi.forEach(function(debit){var true_value=calcTrueValue(debit);Object.assign(debit,{true_value:true_value});});setDebits(response.data);}).catch(function(){toast.error('Erro ao carregar débitos! Por favor, tente novamente mais tarde.');}).finally(function(){setLoadingPage(false);});},[contract_id,calcTrueValue]);return/*#__PURE__*/React.createElement(Container,null,/*#__PURE__*/React.createElement(Loading,{show:loadingPage}),/*#__PURE__*/React.createElement(Header,null),/*#__PURE__*/React.createElement(Aside,null),/*#__PURE__*/React.createElement(Main,null,/*#__PURE__*/React.createElement(Title,{title:\"Gerenciar d\\xE9bitos adicionais\",subtitle:\"Contrato #\".concat(contract_id)}),/*#__PURE__*/React.createElement(Form,{ref:formRef,onSubmit:handleEditExtraDebit},/*#__PURE__*/React.createElement(FormGroup,null,/*#__PURE__*/React.createElement(InputGroup,null,/*#__PURE__*/React.createElement(Input,{icon:FiFileText,name:\"description\",placeholder:\"Descri\\xE7\\xE3o\"}),/*#__PURE__*/React.createElement(Input,{icon:FiDollarSign,type:\"number\",step:\"0.01\",name:\"value\",placeholder:\"Valor\"})),/*#__PURE__*/React.createElement(InputGroup,null,/*#__PURE__*/React.createElement(Input,{icon:FiPercent,type:\"number\",step:\"0.01\",name:\"discount\",placeholder:\"Desconto\"}),/*#__PURE__*/React.createElement(Input,{icon:FiCalendar,type:\"date\",name:\"payment_limit_date\",label:\"Data limite de pagamento\"})),/*#__PURE__*/React.createElement(InputGroup,null,/*#__PURE__*/React.createElement(Checkbox,{name:\"apply_interest_rules\",label:\"Aplicar regras de juros\"})),selectedEditDebit&&/*#__PURE__*/React.createElement(ButtonGroup,null,/*#__PURE__*/React.createElement(Button,{type:\"submit\",loading:loadingSubmit},\"Editar\"),/*#__PURE__*/React.createElement(Button,{type:\"button\",backgroundColor:\"#f44336\",onClick:handleUnselectExtraDebit},\"Cancelar\")))),/*#__PURE__*/React.createElement(Table,{isVoid:debits.length<=0,voidMessage:\"N\\xE3o h\\xE1 d\\xE9bitos para serem pagos!\"},/*#__PURE__*/React.createElement(\"thead\",null,/*#__PURE__*/React.createElement(\"tr\",null,/*#__PURE__*/React.createElement(\"td\",null,\"Descri\\xE7\\xE3o\"),/*#__PURE__*/React.createElement(\"td\",null,\"Valor\"),/*#__PURE__*/React.createElement(\"td\",null,\"Valor com varia\\xE7\\xE3o\"),/*#__PURE__*/React.createElement(\"td\",null,\"Data limite do pagamento\"),/*#__PURE__*/React.createElement(\"td\",null,\"A\\xE7\\xF5es\"))),/*#__PURE__*/React.createElement(\"tbody\",null,debits.map(function(debit){return/*#__PURE__*/React.createElement(Debit,{paid:debit.paid,key:debit.id},/*#__PURE__*/React.createElement(\"td\",null,debit.description),/*#__PURE__*/React.createElement(\"td\",null,formatCoin(debit.value)),/*#__PURE__*/React.createElement(\"td\",null,typeof debit.true_value==='number'?formatCoin(debit.true_value):formatCoin(debit.value)),/*#__PURE__*/React.createElement(\"td\",null,prettyDate(debit.payment_limit_date)),/*#__PURE__*/React.createElement(\"td\",null,/*#__PURE__*/React.createElement(ActionGroup,null,/*#__PURE__*/React.createElement(FiEdit2,{onClick:function onClick(){return handleSelectEditExtraDebit(debit);},size:20,color:\"#212529\"}),/*#__PURE__*/React.createElement(FiTrash,{onClick:function onClick(){return handleSelectDeleteExtraDebit(debit.id);},size:20,color:\"#f44336\"}))));}))),selectedDeleteDebit&&/*#__PURE__*/React.createElement(Popup,{title:\"Deletar d\\xE9bito\",handleClosePopup:handleClosePopup},/*#__PURE__*/React.createElement(Form,{onSubmit:handleDeleteExtraDebit},/*#__PURE__*/React.createElement(WarnMessage,null,/*#__PURE__*/React.createElement(\"strong\",null,\" ATEN\\xC7\\xC3O: \"),\"esta a\\xE7\\xE3o n\\xE3o pode ser desfeita! Digite\",/*#__PURE__*/React.createElement(\"b\",null,\" CONFIRMAR \"),\"para deletar o d\\xE9bito.\"),/*#__PURE__*/React.createElement(InputGroup,null,/*#__PURE__*/React.createElement(Input,{name:\"confirm_message\",icon:FiCheck,value:confirmMessage,onChange:function onChange(e){return setConfirmMessage(e.target.value);}})),/*#__PURE__*/React.createElement(ButtonGroup,null,/*#__PURE__*/React.createElement(Button,{disabled:confirmMessage!=='CONFIRMAR',type:\"submit\",loading:loadingSubmit,backgroundColor:\"#f44336\"},\"Deletar\"))))));};export default ExtraDebitsByContract;","map":{"version":3,"sources":["/home/ondaniel/santiago/sisgie/new_frontend/src/pages/ExtraDebitsByContract/index.tsx"],"names":["React","useEffect","useState","useCallback","useRef","useParams","Form","FiCalendar","FiDollarSign","FiFileText","FiPercent","FiEdit2","FiTrash","FiCheck","Yup","toast","isPast","differenceInCalendarMonths","parseISO","Container","Main","InputGroup","Debit","FormGroup","ButtonGroup","ActionGroup","WarnMessage","Loading","Title","Table","Header","Aside","Input","Button","Popup","api","getValidationErrors","prettyDate","formatCoin","Checkbox","ExtraDebitsByContract","formRef","contract_id","debits","setDebits","selectedEditDebit","setSelectedEditDebit","selectedDeleteDebit","setSelectedDeleteDebit","loadingPage","setLoadingPage","loadingSubmit","setLoadingSubmit","confirmMessage","setConfirmMessage","handleSelectEditExtraDebit","debit","id","current","setErrors","setFieldValue","description","value","discount","payment_limit_date","handleUnselectExtraDebit","reset","handleSelectDeleteExtraDebit","deibt_id","calcTrueValue","parsedDebitDate","toString","true_value","Number","apply_interest_rules","months","Date","handleEditExtraDebit","validateFormData","object","shape","string","required","number","typeError","date","validate","abortEarly","put","response","updatedDebit","data","Object","assign","debitsWithoutUpdated","filter","success","ValidationError","errors","error","message","handleClosePopup","handleDeleteExtraDebit","delete","debitsWithoutDeleted","get","then","debitsFromApi","forEach","catch","finally","length","map","paid","e","target"],"mappings":"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","sourcesContent":["import React, { useEffect, useState, useCallback, useRef } from 'react';\nimport { useParams } from 'react-router-dom';\nimport { Form } from '@unform/web';\nimport { FormHandles } from '@unform/core';\nimport {\n  FiCalendar,\n  FiDollarSign,\n  FiFileText,\n  FiPercent,\n  FiEdit2,\n  FiTrash,\n  FiCheck,\n} from 'react-icons/fi';\nimport * as Yup from 'yup';\nimport { toast } from 'react-toastify';\nimport { isPast, differenceInCalendarMonths, parseISO } from 'date-fns';\n\nimport {\n  Container,\n  Main,\n  InputGroup,\n  Debit,\n  FormGroup,\n  ButtonGroup,\n  ActionGroup,\n  WarnMessage,\n} from './styles';\nimport Loading from '../../components/Loading';\nimport Title from '../../components/Title';\nimport Table from '../../components/Table';\nimport Header from '../../components/Header';\nimport Aside from '../../components/Aside';\nimport Input from '../../components/Input';\nimport Button from '../../components/Button';\nimport Popup from '../../components/Popup';\nimport IDebit from '../../entities/IDebit';\nimport api from '../../services/api';\nimport getValidationErrors from '../../utils/getValidationErrors';\nimport { prettyDate, formatCoin } from '../../utils/formatFunctions';\nimport Checkbox from '../../components/Checkbox';\n\ninterface IFormData {\n  method: 'creditCard' | 'debitCard' | 'cash' | 'check' | 'deposit' | 'slip';\n}\n\ninterface IDebitWithVariation extends IDebit {\n  true_value?: number;\n}\n\ninterface IParams {\n  contract_id: string;\n}\n\ninterface IFormData {\n  description: string;\n  discount: number;\n  payment_limit_date: Date;\n  select_all: boolean;\n  value: number;\n  apply_interest_rules: boolean;\n}\n\nconst ExtraDebitsByContract: React.FC = () => {\n  const formRef = useRef<FormHandles>(null);\n\n  const { contract_id } = useParams<IParams>();\n\n  const [debits, setDebits] = useState([] as IDebitWithVariation[]);\n  const [selectedEditDebit, setSelectedEditDebit] = useState('');\n  const [selectedDeleteDebit, setSelectedDeleteDebit] = useState('');\n  const [loadingPage, setLoadingPage] = useState(false);\n  const [loadingSubmit, setLoadingSubmit] = useState(false);\n  const [confirmMessage, setConfirmMessage] = useState('');\n\n  const handleSelectEditExtraDebit = useCallback(\n    (debit: IDebitWithVariation) => {\n      setSelectedEditDebit(debit.id);\n\n      formRef.current?.setErrors({});\n\n      formRef.current?.setFieldValue('description', debit.description);\n      formRef.current?.setFieldValue('value', debit.value);\n      formRef.current?.setFieldValue('discount', debit.discount);\n      formRef.current?.setFieldValue(\n        'payment_limit_date',\n        debit.payment_limit_date,\n      );\n    },\n    [],\n  );\n\n  const handleUnselectExtraDebit = useCallback(() => {\n    setSelectedEditDebit('');\n    setSelectedDeleteDebit('');\n\n    formRef.current?.setErrors({});\n    formRef.current?.reset();\n  }, []);\n\n  const handleSelectDeleteExtraDebit = useCallback((deibt_id: string) => {\n    setSelectedDeleteDebit(deibt_id);\n  }, []);\n\n  const calcTrueValue = useCallback((debit: IDebitWithVariation): number => {\n    const parsedDebitDate = parseISO(debit.payment_limit_date.toString());\n\n    let true_value = Number(debit.value);\n\n    if (isPast(parsedDebitDate) && debit.apply_interest_rules) {\n      const months = differenceInCalendarMonths(new Date(), parsedDebitDate);\n\n      true_value = debit.value * 1.03 ** months;\n    } else if (!isPast(parsedDebitDate)) {\n      true_value = debit.value - (debit.value * debit.discount) / 100;\n    }\n\n    return true_value;\n  }, []);\n\n  const handleEditExtraDebit = useCallback(\n    async ({\n      description,\n      discount,\n      payment_limit_date,\n      value,\n      apply_interest_rules,\n    }: IFormData) => {\n      try {\n        setLoadingSubmit(true);\n\n        formRef.current?.setErrors({});\n\n        const validateFormData = Yup.object().shape({\n          description: Yup.string().required('Descrião obrigatória'),\n          discount: Yup.number().typeError(\n            () => 'Desconto precisa ser numérico',\n          ),\n          payment_limit_date: Yup.date()\n            .typeError(() => 'Deata inválida')\n            .required(),\n          value: Yup.number()\n            .typeError(() => 'O valor precisa ser numérico')\n            .required(),\n        });\n\n        await validateFormData.validate(\n          {\n            description,\n            discount,\n            payment_limit_date,\n            value,\n          },\n          { abortEarly: false },\n        );\n\n        const response = await api.put(`/debits/extra/${selectedEditDebit}`, {\n          description,\n          discount,\n          payment_limit_date,\n          value,\n          apply_interest_rules,\n        });\n\n        const updatedDebit = response.data as IDebitWithVariation;\n\n        const true_value = calcTrueValue(updatedDebit);\n\n        Object.assign(updatedDebit, { true_value });\n\n        const debitsWithoutUpdated = debits.filter(\n          debit => debit.id !== selectedEditDebit,\n        );\n\n        setDebits([...debitsWithoutUpdated, updatedDebit]);\n\n        formRef.current?.reset();\n\n        setSelectedEditDebit('');\n\n        toast.success('Débito editado com sucesso!');\n      } catch (err) {\n        if (err instanceof Yup.ValidationError) {\n          const errors = getValidationErrors(err);\n          formRef.current?.setErrors(errors);\n          toast.error(\n            'Oops... alguns dados não foram preenchidos corretamente!',\n          );\n          return;\n        }\n\n        if (err.response) {\n          toast.error(`Erro ao editar débito: ${err.response.data.message}`);\n        } else {\n          toast.error(\n            'Erro interno do servidor! Por favor, tente novamente mais tarde.',\n          );\n        }\n      } finally {\n        setLoadingSubmit(false);\n      }\n    },\n    [selectedEditDebit, calcTrueValue, debits],\n  );\n\n  const handleClosePopup = useCallback(() => {\n    setSelectedDeleteDebit('');\n  }, []);\n\n  const handleDeleteExtraDebit = useCallback(async () => {\n    try {\n      setLoadingSubmit(true);\n\n      await api.delete(`/debits/extra/${selectedDeleteDebit}`);\n\n      setSelectedDeleteDebit('');\n\n      const debitsWithoutDeleted = debits.filter(\n        debit => debit.id !== selectedDeleteDebit,\n      );\n\n      setDebits(debitsWithoutDeleted);\n\n      toast.success('Débito excluído com sucesso!');\n    } catch (err) {\n      if (err.response) {\n        toast.error(`Erro ao excluir débito: ${err.response.data.message}`);\n      } else {\n        toast.error(\n          'Erro interno do servidor! Por favor, tente novamente mais tarde.',\n        );\n      }\n    }\n  }, [selectedDeleteDebit, debits]);\n\n  useEffect(() => {\n    setLoadingPage(true);\n    api\n      .get(`contracts/${contract_id}/debits/extra`)\n      .then(response => {\n        const debitsFromApi = response.data;\n\n        debitsFromApi.forEach((debit: IDebitWithVariation) => {\n          const true_value = calcTrueValue(debit);\n\n          Object.assign(debit, { true_value });\n        });\n\n        setDebits(response.data);\n      })\n      .catch(() => {\n        toast.error(\n          'Erro ao carregar débitos! Por favor, tente novamente mais tarde.',\n        );\n      })\n      .finally(() => {\n        setLoadingPage(false);\n      });\n  }, [contract_id, calcTrueValue]);\n\n  return (\n    <Container>\n      <Loading show={loadingPage} />\n\n      <Header />\n\n      <Aside />\n\n      <Main>\n        <Title\n          title=\"Gerenciar débitos adicionais\"\n          subtitle={`Contrato #${contract_id}`}\n        />\n\n        <Form ref={formRef} onSubmit={handleEditExtraDebit}>\n          <FormGroup>\n            <InputGroup>\n              <Input\n                icon={FiFileText}\n                name=\"description\"\n                placeholder=\"Descrição\"\n              />\n\n              <Input\n                icon={FiDollarSign}\n                type=\"number\"\n                step=\"0.01\"\n                name=\"value\"\n                placeholder=\"Valor\"\n              />\n            </InputGroup>\n\n            <InputGroup>\n              <Input\n                icon={FiPercent}\n                type=\"number\"\n                step=\"0.01\"\n                name=\"discount\"\n                placeholder=\"Desconto\"\n              />\n\n              <Input\n                icon={FiCalendar}\n                type=\"date\"\n                name=\"payment_limit_date\"\n                label=\"Data limite de pagamento\"\n              />\n            </InputGroup>\n\n            <InputGroup>\n              <Checkbox\n                name=\"apply_interest_rules\"\n                label=\"Aplicar regras de juros\"\n              />\n            </InputGroup>\n\n            {selectedEditDebit && (\n              <ButtonGroup>\n                <Button type=\"submit\" loading={loadingSubmit}>\n                  Editar\n                </Button>\n\n                <Button\n                  type=\"button\"\n                  backgroundColor=\"#f44336\"\n                  onClick={handleUnselectExtraDebit}\n                >\n                  Cancelar\n                </Button>\n              </ButtonGroup>\n            )}\n          </FormGroup>\n        </Form>\n\n        <Table\n          isVoid={debits.length <= 0}\n          voidMessage=\"Não há débitos para serem pagos!\"\n        >\n          <thead>\n            <tr>\n              <td>Descrição</td>\n              <td>Valor</td>\n              <td>Valor com variação</td>\n              <td>Data limite do pagamento</td>\n              <td>Ações</td>\n            </tr>\n          </thead>\n          <tbody>\n            {debits.map(debit => (\n              <Debit paid={debit.paid} key={debit.id}>\n                <td>{debit.description}</td>\n                <td>{formatCoin(debit.value)}</td>\n                <td>\n                  {typeof debit.true_value === 'number'\n                    ? formatCoin(debit.true_value)\n                    : formatCoin(debit.value)}\n                </td>\n                <td>{prettyDate(debit.payment_limit_date)}</td>\n                <td>\n                  <ActionGroup>\n                    <FiEdit2\n                      onClick={() => handleSelectEditExtraDebit(debit)}\n                      size={20}\n                      color=\"#212529\"\n                    />\n\n                    <FiTrash\n                      onClick={() => handleSelectDeleteExtraDebit(debit.id)}\n                      size={20}\n                      color=\"#f44336\"\n                    />\n                  </ActionGroup>\n                </td>\n              </Debit>\n            ))}\n          </tbody>\n        </Table>\n\n        {selectedDeleteDebit && (\n          <Popup title=\"Deletar débito\" handleClosePopup={handleClosePopup}>\n            <Form onSubmit={handleDeleteExtraDebit}>\n              <WarnMessage>\n                <strong> ATENÇÃO: </strong>\n                esta ação não pode ser desfeita! Digite\n                <b> CONFIRMAR </b>\n                para deletar o débito.\n              </WarnMessage>\n\n              <InputGroup>\n                <Input\n                  name=\"confirm_message\"\n                  icon={FiCheck}\n                  value={confirmMessage}\n                  onChange={e => setConfirmMessage(e.target.value)}\n                />\n              </InputGroup>\n\n              <ButtonGroup>\n                <Button\n                  disabled={confirmMessage !== 'CONFIRMAR'}\n                  type=\"submit\"\n                  loading={loadingSubmit}\n                  backgroundColor=\"#f44336\"\n                >\n                  Deletar\n                </Button>\n              </ButtonGroup>\n            </Form>\n          </Popup>\n        )}\n      </Main>\n    </Container>\n  );\n};\n\nexport default ExtraDebitsByContract;\n"]},"metadata":{},"sourceType":"module"}