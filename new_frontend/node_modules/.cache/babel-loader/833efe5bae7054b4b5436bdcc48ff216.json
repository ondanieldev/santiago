{"ast":null,"code":"var _jsxFileName = \"/home/ondaniel/santiago/sisgie-frontend/src/pages/CreateExtraDebitsByGrade/index.tsx\";\nimport React, { useRef, useCallback, useState, useEffect } from 'react';\nimport { Form } from '@unform/web';\nimport { useParams } from 'react-router-dom';\nimport { toast } from 'react-toastify';\nimport * as Yup from 'yup';\nimport { FiFileText, FiDollarSign, FiPercent, FiCalendar } from 'react-icons/fi';\nimport { Container, Main, ContractsList, Contract, FormGroup, InputGroup } from './styles';\nimport Header from '../../components/Header';\nimport Aside from '../../components/Aside';\nimport Title from '../../components/Title';\nimport Input from '../../components/Input';\nimport Checkbox from '../../components/Checkbox';\nimport Button from '../../components/Button';\nimport Loading from '../../components/Loading';\nimport api from '../../services/api';\nimport getValidationErrors from '../../utils/getValidationErrors';\n\nconst CreateExtraDebitMenu = () => {\n  const [contracts, setContracts] = useState([]);\n  const [loadingPage, setLoadingPage] = useState(true);\n  const [loadingSubmit, setLoadingSubmit] = useState(false);\n  const formRef = useRef(null);\n  const {\n    grade_id\n  } = useParams();\n  const handleSubmitForm = useCallback(async ({\n    contracts_ids,\n    description,\n    discount,\n    payment_limit_date,\n    value,\n    apply_interest_rules\n  }) => {\n    try {\n      var _formRef$current, _formRef$current2;\n\n      setLoadingSubmit(true);\n      (_formRef$current = formRef.current) === null || _formRef$current === void 0 ? void 0 : _formRef$current.setErrors({});\n      const validateFormData = Yup.object().shape({\n        description: Yup.string().required('Descrião obrigatória'),\n        discount: Yup.number().typeError(() => 'Desconto precisa ser numérico'),\n        payment_limit_date: Yup.date().typeError(() => 'Data inválida').required('Data obrigatória'),\n        value: Yup.number().typeError(() => 'O valor precisa ser numérico').required('Valor obrigatório')\n      });\n      await validateFormData.validate({\n        description,\n        discount,\n        payment_limit_date,\n        value\n      }, {\n        abortEarly: false\n      });\n      const selectedContracts = Object.entries(contracts_ids);\n      const promises = [];\n      selectedContracts.forEach(([contract_id, selected]) => {\n        if (selected) {\n          promises.push(api.post('/debits/extra', {\n            contract_id,\n            description,\n            discount,\n            payment_limit_date,\n            value,\n            apply_interest_rules\n          }));\n        }\n      });\n      await Promise.all(promises);\n      (_formRef$current2 = formRef.current) === null || _formRef$current2 === void 0 ? void 0 : _formRef$current2.reset();\n      toast.success('Débitos criados com sucesso!');\n    } catch (err) {\n      if (err instanceof Yup.ValidationError) {\n        var _formRef$current3;\n\n        const errors = getValidationErrors(err);\n        (_formRef$current3 = formRef.current) === null || _formRef$current3 === void 0 ? void 0 : _formRef$current3.setErrors(errors);\n        toast.error('Oops... alguns dados não foram preenchidos corretamente!');\n        return;\n      }\n\n      if (err.response) {\n        toast.error(`Erro ao criar débito: ${err.response.data.message}`);\n      } else {\n        toast.error('Erro interno do servidor! Por favor, tente novamente mais tarde.');\n      }\n    } finally {\n      setLoadingSubmit(false);\n    }\n  }, []);\n  const handleToggleAll = useCallback(state => {\n    contracts.forEach(contract => {\n      var _formRef$current4;\n\n      (_formRef$current4 = formRef.current) === null || _formRef$current4 === void 0 ? void 0 : _formRef$current4.setFieldValue(`contracts_ids.${contract.id}`, !!state.checked);\n    });\n  }, [contracts]);\n  useEffect(() => {\n    api.get(`/contracts/active/grades/${grade_id}`).then(response => {\n      const contractsFromApi = response.data;\n      setContracts(contractsFromApi);\n    }).catch(() => {\n      toast.error('Erro ao buscar dados do servidor! Por favor, tente novamente mais tarde.');\n    }).finally(() => {\n      setLoadingPage(false);\n    });\n  }, [grade_id]);\n  return /*#__PURE__*/React.createElement(Container, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 181,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Loading, {\n    show: loadingPage,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 182,\n      columnNumber: 7\n    }\n  }), /*#__PURE__*/React.createElement(Header, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 184,\n      columnNumber: 7\n    }\n  }), /*#__PURE__*/React.createElement(Aside, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 186,\n      columnNumber: 7\n    }\n  }), /*#__PURE__*/React.createElement(Main, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 188,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Title, {\n    title: \"Criar d\\xE9bitos adicionais\",\n    subtitle: \"Preencha os dados do d\\xE9bito e selecione as matr\\xEDculas em que ser\\xE3o aplicados\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 189,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(Form, {\n    ref: formRef,\n    onSubmit: handleSubmitForm,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 194,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(FormGroup, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 195,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(InputGroup, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 196,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Input, {\n    icon: FiFileText,\n    name: \"description\",\n    placeholder: \"Descri\\xE7\\xE3o\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 197,\n      columnNumber: 15\n    }\n  }), /*#__PURE__*/React.createElement(Input, {\n    icon: FiDollarSign,\n    type: \"number\",\n    step: \"0.01\",\n    name: \"value\",\n    placeholder: \"Valor\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 203,\n      columnNumber: 15\n    }\n  })), /*#__PURE__*/React.createElement(InputGroup, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 212,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Input, {\n    icon: FiPercent,\n    type: \"number\",\n    step: \"0.01\",\n    name: \"discount\",\n    placeholder: \"Desconto\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 213,\n      columnNumber: 15\n    }\n  }), /*#__PURE__*/React.createElement(Input, {\n    icon: FiCalendar,\n    type: \"date\",\n    name: \"payment_limit_date\",\n    label: \"Data limite de pagamento\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 221,\n      columnNumber: 15\n    }\n  })), /*#__PURE__*/React.createElement(InputGroup, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 229,\n      columnNumber: 13\n    }\n  }, /*#__PURE__*/React.createElement(Checkbox, {\n    name: \"apply_interest_rules\",\n    label: \"Aplicar regras de juros\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 230,\n      columnNumber: 15\n    }\n  }))), /*#__PURE__*/React.createElement(ContractsList, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 237,\n      columnNumber: 11\n    }\n  }, /*#__PURE__*/React.createElement(Checkbox, {\n    name: \"select_all\",\n    label: \"Selecionar todos\",\n    onClick: e => handleToggleAll(e.target),\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 238,\n      columnNumber: 13\n    }\n  }), contracts.map(contract => /*#__PURE__*/React.createElement(Contract, {\n    key: contract.id,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 245,\n      columnNumber: 15\n    }\n  }, /*#__PURE__*/React.createElement(Checkbox, {\n    name: `contracts_ids.${contract.id}`,\n    label: contract.student.name,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 246,\n      columnNumber: 17\n    }\n  })))), /*#__PURE__*/React.createElement(Button, {\n    loading: loadingSubmit,\n    type: \"submit\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 254,\n      columnNumber: 11\n    }\n  }, \"Criar\"))));\n};\n\nexport default CreateExtraDebitMenu;","map":{"version":3,"sources":["/home/ondaniel/santiago/sisgie-frontend/src/pages/CreateExtraDebitsByGrade/index.tsx"],"names":["React","useRef","useCallback","useState","useEffect","Form","useParams","toast","Yup","FiFileText","FiDollarSign","FiPercent","FiCalendar","Container","Main","ContractsList","Contract","FormGroup","InputGroup","Header","Aside","Title","Input","Checkbox","Button","Loading","api","getValidationErrors","CreateExtraDebitMenu","contracts","setContracts","loadingPage","setLoadingPage","loadingSubmit","setLoadingSubmit","formRef","grade_id","handleSubmitForm","contracts_ids","description","discount","payment_limit_date","value","apply_interest_rules","current","setErrors","validateFormData","object","shape","string","required","number","typeError","date","validate","abortEarly","selectedContracts","Object","entries","promises","forEach","contract_id","selected","push","post","Promise","all","reset","success","err","ValidationError","errors","error","response","data","message","handleToggleAll","state","contract","setFieldValue","id","checked","get","then","contractsFromApi","catch","finally","e","target","map","student","name"],"mappings":"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","sourcesContent":["import React, { useRef, useCallback, useState, useEffect } from 'react';\nimport { FormHandles } from '@unform/core';\nimport { Form } from '@unform/web';\nimport { useParams } from 'react-router-dom';\nimport { toast } from 'react-toastify';\nimport * as Yup from 'yup';\nimport { AxiosResponse } from 'axios';\nimport {\n  FiFileText,\n  FiDollarSign,\n  FiPercent,\n  FiCalendar,\n} from 'react-icons/fi';\n\nimport {\n  Container,\n  Main,\n  ContractsList,\n  Contract,\n  FormGroup,\n  InputGroup,\n} from './styles';\nimport Header from '../../components/Header';\nimport Aside from '../../components/Aside';\nimport Title from '../../components/Title';\nimport Input from '../../components/Input';\nimport Checkbox from '../../components/Checkbox';\nimport Button from '../../components/Button';\nimport Loading from '../../components/Loading';\nimport IContract from '../../entities/IContract';\nimport api from '../../services/api';\nimport getValidationErrors from '../../utils/getValidationErrors';\n\ninterface IParams {\n  grade_id: string;\n}\n\ninterface IContractProps extends IContract {\n  selected?: boolean;\n}\n\ninterface IFormContracts {\n  [key: string]: boolean;\n}\n\ninterface IFormData {\n  description: string;\n  discount: number;\n  payment_limit_date: Date;\n  select_all: boolean;\n  value: number;\n  apply_interest_rules: boolean;\n  contracts_ids: IFormContracts;\n}\n\nconst CreateExtraDebitMenu: React.FC = () => {\n  const [contracts, setContracts] = useState<IContractProps[]>([]);\n  const [loadingPage, setLoadingPage] = useState(true);\n  const [loadingSubmit, setLoadingSubmit] = useState(false);\n\n  const formRef = useRef<FormHandles>(null);\n\n  const { grade_id } = useParams<IParams>();\n\n  const handleSubmitForm = useCallback(\n    async ({\n      contracts_ids,\n      description,\n      discount,\n      payment_limit_date,\n      value,\n      apply_interest_rules,\n    }: IFormData) => {\n      try {\n        setLoadingSubmit(true);\n\n        formRef.current?.setErrors({});\n\n        const validateFormData = Yup.object().shape({\n          description: Yup.string().required('Descrião obrigatória'),\n          discount: Yup.number().typeError(\n            () => 'Desconto precisa ser numérico',\n          ),\n          payment_limit_date: Yup.date()\n            .typeError(() => 'Data inválida')\n            .required('Data obrigatória'),\n          value: Yup.number()\n            .typeError(() => 'O valor precisa ser numérico')\n            .required('Valor obrigatório'),\n        });\n\n        await validateFormData.validate(\n          {\n            description,\n            discount,\n            payment_limit_date,\n            value,\n          },\n          { abortEarly: false },\n        );\n\n        const selectedContracts = Object.entries(contracts_ids);\n\n        const promises = [] as Promise<AxiosResponse>[];\n\n        selectedContracts.forEach(([contract_id, selected]) => {\n          if (selected) {\n            promises.push(\n              api.post('/debits/extra', {\n                contract_id,\n                description,\n                discount,\n                payment_limit_date,\n                value,\n                apply_interest_rules,\n              }),\n            );\n          }\n        });\n\n        await Promise.all(promises);\n\n        formRef.current?.reset();\n\n        toast.success('Débitos criados com sucesso!');\n      } catch (err) {\n        if (err instanceof Yup.ValidationError) {\n          const errors = getValidationErrors(err);\n          formRef.current?.setErrors(errors);\n          toast.error(\n            'Oops... alguns dados não foram preenchidos corretamente!',\n          );\n          return;\n        }\n\n        if (err.response) {\n          toast.error(`Erro ao criar débito: ${err.response.data.message}`);\n        } else {\n          toast.error(\n            'Erro interno do servidor! Por favor, tente novamente mais tarde.',\n          );\n        }\n      } finally {\n        setLoadingSubmit(false);\n      }\n    },\n    [],\n  );\n\n  const handleToggleAll = useCallback(\n    (state: HTMLInputElement) => {\n      contracts.forEach(contract => {\n        formRef.current?.setFieldValue(\n          `contracts_ids.${contract.id}`,\n          !!state.checked,\n        );\n      });\n    },\n    [contracts],\n  );\n\n  useEffect(() => {\n    api\n      .get(`/contracts/active/grades/${grade_id}`)\n      .then(response => {\n        const contractsFromApi = response.data as IContractProps[];\n\n        setContracts(contractsFromApi);\n      })\n      .catch(() => {\n        toast.error(\n          'Erro ao buscar dados do servidor! Por favor, tente novamente mais tarde.',\n        );\n      })\n      .finally(() => {\n        setLoadingPage(false);\n      });\n  }, [grade_id]);\n\n  return (\n    <Container>\n      <Loading show={loadingPage} />\n\n      <Header />\n\n      <Aside />\n\n      <Main>\n        <Title\n          title=\"Criar débitos adicionais\"\n          subtitle=\"Preencha os dados do débito e selecione as matrículas em que serão aplicados\"\n        />\n\n        <Form ref={formRef} onSubmit={handleSubmitForm}>\n          <FormGroup>\n            <InputGroup>\n              <Input\n                icon={FiFileText}\n                name=\"description\"\n                placeholder=\"Descrição\"\n              />\n\n              <Input\n                icon={FiDollarSign}\n                type=\"number\"\n                step=\"0.01\"\n                name=\"value\"\n                placeholder=\"Valor\"\n              />\n            </InputGroup>\n\n            <InputGroup>\n              <Input\n                icon={FiPercent}\n                type=\"number\"\n                step=\"0.01\"\n                name=\"discount\"\n                placeholder=\"Desconto\"\n              />\n\n              <Input\n                icon={FiCalendar}\n                type=\"date\"\n                name=\"payment_limit_date\"\n                label=\"Data limite de pagamento\"\n              />\n            </InputGroup>\n\n            <InputGroup>\n              <Checkbox\n                name=\"apply_interest_rules\"\n                label=\"Aplicar regras de juros\"\n              />\n            </InputGroup>\n          </FormGroup>\n\n          <ContractsList>\n            <Checkbox\n              name=\"select_all\"\n              label=\"Selecionar todos\"\n              onClick={e => handleToggleAll(e.target as HTMLInputElement)}\n            />\n\n            {contracts.map(contract => (\n              <Contract key={contract.id}>\n                <Checkbox\n                  name={`contracts_ids.${contract.id}`}\n                  label={contract.student.name}\n                />\n              </Contract>\n            ))}\n          </ContractsList>\n\n          <Button loading={loadingSubmit} type=\"submit\">\n            Criar\n          </Button>\n        </Form>\n      </Main>\n    </Container>\n  );\n};\n\nexport default CreateExtraDebitMenu;\n"]},"metadata":{},"sourceType":"module"}